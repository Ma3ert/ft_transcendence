"use client";
import { Avatar, Button, Input, Stack, Wrap, Box, Icon, WrapItem, FormControl } from '@chakra-ui/react'
import {FaArrowCircleRight} from "react-icons/fa"
import IconButton from '@/components/IconButton';
import Logo from "@/components/Logo"
import { useContext, useState } from 'react';
import Link from 'next/link';
import {AuthUser} from "@/context/Contexts"
import apiClient from '@/services/requestProcessor';
import axios, { AxiosResponse } from 'axios';
import {FaPen} from "react-icons/fa"

export default function Home() {
  const client = new apiClient("/users");
  const [send, setSend] = useState("");
  const { currentUser, setCurrentUser } = useContext(AuthUser)
  const [newAvatar, setNewAvatar] = useState("");

  if (currentUser === null)
  {
    client.getData("/me").then((res: AxiosResponse)=> {
      setCurrentUser(res.data.data)
      setNewAvatar("http://127.0.0.1:3000/public/users/imgs/" + res.data.data.avatar)
    })
  }

  const handlePreview = (event: React.ChangeEvent<HTMLInputElement>) => {
    console.log(event.target.files)
    const currentFiles = event.target.files
    if (currentFiles && currentFiles?.length > 0){
      let src: string = URL.createObjectURL(currentFiles[0]);
      setNewAvatar(src)
    }
  }

  const handleOnSubmit = (event: React.FormEvent<HTMLFormElement>) => {
    event.preventDefault()
    const formData = new FormData(event.target as HTMLFormElement);
    // const userName: string = formData.get("newUserName") as string;
    // const imageFile = (document.getElementById('avatar') as HTMLInputElement).files?.[0];
    // const image: string | undefined = imageFile ? imageFile.name : undefined;
  
    // console.log("username:", userName);
    // console.log("image:", image);
    client.patchData(formData, "/" + currentUser.id)
    // .then(() => {client.getData("/me").then((res: AxiosResponse)=> {setCurrentUser(res.data.data)})})
  }

  return (
    <Stack
      spacing={"10vh"}
      align="center"
      minH="70vh"
      >
        <Logo src='/logo.png' width="334px" height="179px"></Logo>
        <form onSubmit={handleOnSubmit}>
          <Stack align={"center"} spacing={"40px"}>
            <Stack align={"center"} spacing={{base: "10px" ,lg:"20px" }}>
              <Input onChange={handlePreview} visibility={"hidden"} w={0} h={0} type='file' id='avatar' name='avatar'/>
              <Wrap align={"end"} position={"relative"}>
                <Avatar zIndex={0} boxSize={{base: "100px", xl: "137px" }} 
                  src={newAvatar}></Avatar>
                <Box
                  as='label'
                  htmlFor='avatar'
                  zIndex={1}
                  boxSize={"30px"} 
                  borderRadius={"full"}
                  bg={"#DC585B"} color={"#fff"} 
                  display={"flex"} alignItems={"center"} justifyContent={"center"}
                  position={"absolute"}
                  left={"70%"}
                >
                  <Icon as={FaPen} style={{ fontSize: "14px" }} />
                </Box>
              </Wrap>
            </Stack>
            <Stack align={"center"} spacing={{base: "10px" ,lg:"20px" }}>
              <Input
                id='username'
                name='username'
                variant={"default"}
                w={{ base: "280px", lg: "340px" }}
                h={{ base: "50px",lg: "66px" }}
                placeholder={currentUser ? currentUser.username : 'new Username'}/>
              <Stack align={"center"} spacing={{base: "6px", lg:"8px" }}>
                <Button
                  fontSize={{base: "15px", lg: "20px" }}
                  variant={"ghost"}
                  type='submit'
                >Apply Changes</Button>
                <Link href={"/Lobby"}>
                  <Button
                    fontSize={{base: "15px", lg: "20px" }}
                    variant={"ghost"}
                    >skip</Button>
                </Link>
              </Stack>
            </Stack>
          </Stack>
        </form>
    </Stack>
  )
}